/*!
 *
 * Bryntum TaskBoard 5.6.2
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Histogram as He,Scale as Fe}from"./chunk-DAJIBEHV.js";import{AbstractTimeRanges as Me,DragBase as Be,DragCreateBase as Oe,TooltipBase as _e}from"./chunk-PFWHNAB4.js";import{AttachToProjectMixin_default as de,TimelineBase as Pe}from"./chunk-MS4QMERY.js";import{Column as ke,ColumnStore as Le,CopyPasteBase as Ie,GridFeatureManager as A}from"./chunk-GGOYEX2W.js";import{DependencyModel as Ce,TimeSpan as je}from"./chunk-KVD75ID2.js";import{ArrayHelper as ue,Base as De,DateHelper as _,Delayable_default as We,DomHelper as w,DomSync as ge,Duration as $e,EventHelper as ee,InstancePlugin as se,ObjectHelper as W,Objects as N,Popup as Ge,Rectangle as P,StringHelper as ye,Tooltip as Ve,__publicField as v,parseAlign as ze}from"./chunk-MZVS5JQA.js";var U=class extends ke{static get fields(){return["scalePoints"]}static get defaults(){return{text:"\xA0",width:40,minWidth:40,field:"scalePoints",cellCls:"b-scale-cell",editor:!1,sortable:!1,groupable:!1,filterable:!1,alwaysClearCell:!1,scalePoints:null}}onDestroy(){this.scaleWidget.destroy()}set width(e){super.width=e,this.scaleWidget.width=e}get width(){return super.width}applyValue(e,r,t){return r==="scalePoints"&&(this.scaleWidget[r]=t),super.applyValue(...arguments)}buildScaleWidget(){const e=this,r=new Fe({owner:e.grid,appendTo:e.grid.floatRoot,cls:"b-hide-offscreen",align:"right",scalePoints:e.scalePoints,monitorResize:!1});return Object.defineProperties(r,{width:{get(){return e.width},set(t){this.element.style.width=`${t}px`,this._width=e.width}},height:{get(){return this._height},set(t){this.element.style.height=`${t}px`,this._height=t}}}),r.width=e.width,r}get scaleWidget(){const e=this;return e._scaleWidget||(e._scaleWidget=e.buildScaleWidget()),e._scaleWidget}renderer({cellElement:e,value:r,scaleWidgetConfig:t,scaleWidget:s=this.scaleWidget}){W.assign(s,{scalePoints:r||this.scalePoints,height:this.grid.rowHeight},t),s.refresh();const n=s.element.cloneNode(!0);n.removeAttribute("id"),n.classList.remove("b-hide-offscreen"),e.innerHTML="",e.appendChild(n)}};v(U,"$name","ScaleColumn"),v(U,"type","scale"),v(U,"isScaleColumn",!0),Le.registerColumnType(U),U._$name="ScaleColumn";var ne=class extends se.mixin(de){static get pluginConfig(){return{chain:["getEventsToRender","onEventDataGenerated","noFeatureElementsInAxis"],override:["matchScheduleCell","resolveResourceRecord"]}}noFeatureElementsInAxis(){const{timeAxis:e}=this.client;return!this.needsRefresh&&this.store&&!this.store.storage.values.some(r=>e.isTimeSpanInAxis(r))}doDisable(e){this.client.isPainted&&this.client.refresh(),super.doDisable(e)}updateTabIndex(){this.isConfiguring||this.client.refresh()}getEventsToRender(e,r){throw new Error("Implement in subclass")}onEventDataGenerated(e){const r=this,{client:t}=r,{eventRecord:s,iconCls:n}=e;r.shouldInclude(s)&&(t.isVertical?e.width=e.resourceRecord.columnWidth||t.resourceColumnWidth:e.top=0,e.fillSize=!0,e.wrapperCls["b-sch-resourcetimerange"]=1,r.rangeCls&&(e.wrapperCls[r.rangeCls]=1),e.wrapperCls[`b-sch-color-${s.timeRangeColor}`]=s.timeRangeColor,r.renderContent(s,e),e.children.push(e.eventContent),e.tabIndex=r.tabIndex!=null?String(r.tabIndex):null,(n==null?void 0:n.length)>0&&e.children.unshift({tag:"i",className:n.toString()}),e.eventId=r.generateElementId(s))}renderContent(e,r){r.eventContent.text=e.name}generateElementId(e){return e.domId}resolveResourceTimeRangeRecord(e){var r;return(r=e==null?void 0:e.closest(`.${this.rangeCls}`))==null?void 0:r.elementData.eventRecord}getElementFromResourceTimeRangeRecord(e){return this.client.foregroundCanvas.syncIdMap[e.domId]}resolveResourceRecord(e){var r;return this.overridden.resolveResourceRecord(...arguments)||((r=this.resolveResourceTimeRangeRecord(e.target||e))==null?void 0:r.resource)}shouldInclude(e){throw new Error("Implement in subclass")}onStoreChange(e){(e.action==="removeall"||e.action==="dataset")&&(this.needsRefresh=!0),this.client.onInternalEventStoreChange(e),this.needsRefresh=!1}matchScheduleCell(e){let r=this.overridden.matchScheduleCell(e);if(!r&&this.enableMouseEvents){const{client:t}=this,s=e.closest(`.${this.rangeCls}`);r=s&&t.getCell({record:t.isHorizontal?s.elementData.resource:t.store.first,column:t.timeAxisColumn})}return r}handleRangeMouseEvent(e){var r;const t=this,s=e.target.closest(`.${t.rangeCls}`);if(s){const n=(r=ee.eventNameMap[e.type])!=null?r:ye.capitalize(e.type),i=t.resolveResourceTimeRangeRecord(s);t.client.trigger(t.entityName+n,{feature:t,[`${t.entityName}Record`]:i,resourceRecord:t.client.resourceStore.getById(i.resourceId),domEvent:e})}}updateEnableMouseEvents(e){var r;const t=this,{client:s}=t;if((r=t.mouseEventsDetacher)==null||r.call(t),t.mouseEventsDetacher=null,e){let n=function(){t.mouseEventsDetacher=ee.on({element:s.foregroundCanvas,delegate:`.${t.rangeCls}`,mousedown:"handleRangeMouseEvent",mouseup:"handleRangeMouseEvent",click:"handleRangeMouseEvent",dblclick:"handleRangeMouseEvent",contextmenu:"handleRangeMouseEvent",mouseover:"handleRangeMouseEvent",mouseout:"handleRangeMouseEvent",thisObj:t})};s.whenVisible(n)}s.element.classList.toggle("b-interactive-resourcetimeranges",!!e)}};v(ne,"configurable",{tabIndex:null,entityName:"resourceTimeRange"}),ne.featureClass="",ne._$name="ResourceTimeRangesBase";var Ee=class extends Ge{static get $name(){return"DependencyEditor"}static get defaultConfig(){return{items:[],draggable:{handleSelector:":not(button,.b-field-inner)"},axisLock:"flexible"}}processWidgetConfig(e){const{dependencyEditFeature:r}=this;return e.ref==="lagField"&&!r.showLagField||e.ref==="deleteButton"&&!r.showDeleteButton?!1:super.processWidgetConfig(e)}afterShow(...e){const{deleteButton:r}=this.widgetMap;r&&(r.hidden=!this.record.isPartOfStore()),super.afterShow(...e)}onInternalKeyDown(e){this.trigger("keyDown",{event:e}),super.onInternalKeyDown(e)}};Ee._$name="DependencyEditor";var he=class extends se{static get $name(){return"DependencyEdit"}static get configurable(){return{autoClose:!0,saveAndCloseOnEnter:!0,showDeleteButton:!0,triggerEvent:"dependencydblclick",showLagField:!1,dependencyRecord:null,editorConfig:{title:"L{Edit dependency}",localeClass:this,closable:!0,defaults:{localeClass:this},items:{fromNameField:{type:"display",weight:100,label:"L{From}"},toNameField:{type:"display",weight:200,label:"L{To}"},typeField:{type:"combo",weight:300,label:"L{Type}",name:"type",editable:!1,valueField:"id",displayField:"name",localizeDisplayFields:!0,buildItems:function(){const e=this.parent;return Object.keys(Ce.Type).map(r=>({id:Ce.Type[r],name:e.L(r),localeKey:r}))}},lagField:{type:"duration",weight:400,label:"L{Lag}",name:"lag",allowNegative:!0,highlightExternalChange:!1}},bbar:{defaults:{localeClass:this},items:{foo:{type:"widget",cls:"b-label-filler"},saveButton:{color:"b-green",text:"L{Save}"},deleteButton:{color:"b-gray",text:"L{Delete}"},cancelButton:{color:"b-gray",text:"L{Object.Cancel}"}}}}}}construct(e,r){const t=this;if(e.dependencyEdit=t,super.construct(e,r),!e.features.dependencies)throw new Error("Dependencies feature required when using DependencyEdit");t.clientListenersDetacher=e.ion({[t.triggerEvent]:t.onActivateEditor,thisObj:t})}doDestroy(){var e;this.clientListenersDetacher(),(e=this.editor)==null||e.destroy(),super.doDestroy()}changeEditorConfig(e){const r=this,{autoClose:t,cls:s,client:n}=r;return W.assign({owner:n,align:"b-t",id:`${n.id}-dependency-editor`,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,autoClose:t,cls:s},e)}get isValid(){return Object.values(this.editor.widgetMap).every(e=>!e.name||e.hidden?!0:e.isValid!==!1)}get values(){const e={};return this.editor.eachWidget(r=>{!r.name||r.hidden||(e[r.name]=r.value)},!0),e}onBeforeSave(e){}onAfterSave(e){}updateRecord(e){const{values:r}=this;r.lag&&(r.lagUnit=r.lag.unit,r.lag=r.lag.magnitude),"type"in r&&(e.fromSide!=null&&(r.fromSide=null),e.toSide!=null&&(r.toSide=null)),W.cleanupProperties(r,!0),e.set(r)}onPopupKeyDown({event:e}){e.key==="Enter"&&this.saveAndCloseOnEnter&&e.target.tagName.toLowerCase()==="input"&&(e.preventDefault(),this.onSaveClick())}onSaveClick(){this.save()&&(this.afterSave(),this.editor.hide())}async onDeleteClick(){await this.deleteDependency()&&this.afterDelete(),this.editor.hide()}onCancelClick(){this.afterCancel(),this.editor.hide()}afterSave(){}afterDelete(){}afterCancel(){}internalShowEditor(e){const r=this,{client:t}=r,s=r.getEditor(e);r.loadRecord(e),t.trigger("beforeDependencyEditShow",{dependencyEdit:r,dependencyRecord:e,editor:s});let n=r.lastPointerDownCoordinate;if(!n){const l=P.from(t.element).center;n=[l.x-s.width/2,l.y-s.height/2]}const i=s.showBy(n),a=[];let o=0;return s.eachWidget(l=>{const{labelElement:c,element:d}=l;if(c){if(c.getBoundingClientRect().top<d.getBoundingClientRect().top)return!1;l.labelWidth=null,o=Math.max(o,c.offsetWidth),a.push(l)}}),a.forEach(l=>l.labelWidth=o),i}async editDependency(e){const r=this,{client:t}=r;return t.readOnly||e.readOnly||await t.trigger("beforeDependencyEdit",{dependencyEdit:r,dependencyRecord:e})===!1?!1:(await this.internalShowEditor(e),!0)}getEditor(){var e,r,t;const s=this;let{editor:n}=s;return n||(n=s.editor=Ee.new({dependencyEditFeature:s,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,autoClose:s.autoClose,cls:s.cls,rootElement:s.client.rootElement,internalListeners:{keydown:s.onPopupKeyDown,thisObj:s}},s.editorConfig),n.items.length===0&&console.warn("Editor configured without any `items`"),n.eachWidget(i=>{const a=i.ref||i.id;a&&!s[a]&&(s[a]=i)}),(e=s.saveButton)==null||e.ion({click:"onSaveClick",thisObj:s}),(r=s.deleteButton)==null||r.ion({click:"onDeleteClick",thisObj:s}),(t=s.cancelButton)==null||t.ion({click:"onCancelClick",thisObj:s}),s.editor)}loadRecord(e){const r=this;r.fromNameField.value=e.fromEvent.name,r.toNameField.value=e.toEvent.name,r.lagField&&(r.lagField.value=new $e(e.lag,e.lagUnit)),r.editor.record=r.dependencyRecord=e}async save(){var e;const r=this,{client:t,dependencyRecord:s}=r;if(!s||!r.isValid)return;const{dependencyStore:n,values:i}=r;if(t.trigger("beforeDependencySave",{dependencyRecord:s,values:i})!==!1){if(r.onBeforeSave(s),r.updateRecord(s),n&&!s.stores.length){if(t.trigger("beforeDependencyAdd",{dependencyRecord:s,dependencyEdit:r})===!1)return;n.add(s)}await((e=t.project)==null?void 0:e.commitAsync()),t.trigger("afterDependencySave",{dependencyRecord:s}),r.onAfterSave(s)}return s}async deleteDependency(){var e;const{client:r,editor:t,dependencyRecord:s}=this;return r.trigger("beforeDependencyDelete",{dependencyRecord:s})!==!1?(t.containsFocus&&t.revertFocus(),r.dependencyStore.remove(s),await((e=r.project)==null?void 0:e.commitAsync()),!0):!1}get dependencyStore(){return this.client.dependencyStore}onActivateEditor({dependency:e,event:r}){this.disabled||(this.lastPointerDownCoordinate=[r.clientX,r.clientY],this.editDependency(e))}};he._$name="DependencyEdit",A.registerFeature(he,!1);var K=class extends se.mixin(We){static get $name(){return"ScheduleContext"}construct(e,r){super.construct(e,r);const{triggerEvent:t}=this,s={datachange:"syncContextElement",timeaxisviewmodelupdate:"onTimeAxisViewModelUpdate",presetchange:"clearContext",thisObj:this};t==="mouseover"?s.timelineContextChange="onTimelineContextChange":((t==="click"||t==="mousedown")&&(s.schedulecontextmenu="onScheduleContextGesture"),Object.assign(s,{[`schedule${t}`]:"onScheduleContextGesture",[`event${t}`]:"onScheduleContextGesture",...s})),e.ion(s),e.rowManager.ion({rowheight:"syncContextElement",thisObj:this})}changeTriggerEvent(e){return(e==="hover"||e==="mousemove")&&(e="mouseover"),e}get element(){return this._element||(this._element=w.createElement({parent:this.client.timeAxisSubGridElement,className:"b-schedule-selected-tick"}))}onTimelineContextChange({context:e}){this.context=e}onScheduleContextGesture(e){this.context=e}onTimeAxisViewModelUpdate({source:e}){var r;e.timeAxis.includes((r=this.context)==null?void 0:r.tick)?this.syncContextElement():this.clearContext()}clearContext(){this.context=null}updateContext(e,r){this.syncContextElement()}syncContextElement(){if(this.context&&this.enabled){const e=this,{client:r,element:t,context:s,renderer:n}=e,{isVertical:i}=r,{style:a}=t,o=i?r.rowManager.rows[0]:r.getRowFor(s.resourceRecord);if(o){const{tickStartDate:l,tickEndDate:c,resourceRecord:d}=s,u=r.currentOrientation.getTimeSpanRenderData({startDate:l,endDate:c,startDateMS:l.getTime(),endDateMS:c.getTime()},d);let h,p,C;i?(h=u.top,p=u.resourceWidth,C=u.height):(h=o.top,p=u.width,C=o.height),a.display="",a.width=`${p}px`,a.height=`${C}px`,w.setTranslateXY(t,u.left,h),s.index=o.index,t.innerHTML="",n&&e.callback(n,e,[s,t])}else a.display="none"}else this.element.style.display="none"}};v(K,"delayable",{syncContextElement:"raf"}),v(K,"configurable",{triggerEvent:"click",renderer:null,context:{$config:{equal(e,r){return(e==null?void 0:e.index)===(r==null?void 0:r.index)&&(e==null?void 0:e.tickParentIndex)===(r==null?void 0:r.tickParentIndex)&&!(((e==null?void 0:e.tickStartDate)||0)-((r==null?void 0:r.tickStartDate)||0))}}}}),K.featureClass="b-scheduler-context",K._$name="ScheduleContext",A.registerFeature(K,!1,["Scheduler"]);var Ne={cut:1,copy:1,paste:1},$=class extends Ie.mixin(de){constructor(){super(...arguments),v(this,"entityName","event")}construct(e,r){super.construct(e,r),e.ion({eventClick:"onEventClick",scheduleClick:"onScheduleClick",projectChange:()=>{this.clearClipboard(),this._cellClickedContext=null},thisObj:this})}get scheduler(){return this.client}attachToEventStore(e){super.attachToEventStore(e),delete this._eventClickedContext}onEventDataGenerated(e){const{assignmentRecord:r}=e;r&&(e.cls["b-cut-item"]=r.meta.isCut)}onEventClick(e){this._cellClickedContext=null,this._eventClickedContext=e}onScheduleClick(e){this._cellClickedContext=e,this._eventClickedContext=null}isActionAvailable({event:e,actionName:r}){var t,s;if(Ne[r])return!this.disabled&&globalThis.getSelection().toString().length===0&&!((t=this.client.features.cellEdit)!=null&&t.isEditing)&&!!e.target.closest(".b-timeaxissubgrid")&&!((s=this.client.focusedCell)!=null&&s.isSpecialRow)}async copy(){await this.copyEvents()}async cut(){await this.copyEvents(void 0,!0)}async paste(){await this.pasteEvents()}async copyEvents(e=this.scheduler.selectedAssignments,r=!1){const t=this,{scheduler:s}=t;if(s.splitFrom)return s.splitFrom.features.eventCopyPaste.copyEvents(e,r);if(!(e!=null&&e.length))return;let n=e.slice();e[0].isEventModel&&(n=e.map(a=>a.assignments).flat()),r&&(n=n.filter(a=>!a.event.readOnly));const i=n.map(a=>a.event);!n.length||s.readOnly||(await t.writeToClipboard({assignmentRecords:n,eventRecords:i},r),s.trigger("copy",{assignmentRecords:n,eventRecords:i,isCut:r,entityName:t.entityName}),s.refreshWithTransition(),t._focusedEventOnCopy=t._eventClickedContext)}async beforeCopy({data:{assignmentRecords:e,eventRecords:r},isCut:t}){return await this.scheduler.trigger("beforeCopy",{assignmentRecords:e,eventRecords:r,isCut:t,entityName:this.entityName})}handleCutData({source:e}){var r;const t=this;if(e!==t&&((r=t.cutData)!=null&&r.length)){const{assignmentRecords:s,eventRecords:n}=t.cutData[0];s!=null&&s.length&&t.scheduler.assignmentStore.remove(s),n!=null&&n.length&&t.scheduler.eventStore.remove(n)}}stringConverter({eventRecords:e}){const r=[];for(const t of e)r.push(this.eventToStringFields.map(s=>{const n=t[s];return n instanceof Date?_.format(n,this.dateFormat):n}).join("	"));return r.join(`
`)}setIsCut({assignmentRecords:e},r){e.forEach(t=>{t.meta.isCut=r}),this.scheduler.refreshWithTransition()}async pasteEvents(e,r){var t;const s=this,{scheduler:n}=s;if(n.splitFrom)return n.splitFrom.features.eventCopyPaste.pasteEvents(e,r);const{entityName:i,isCut:a,_cellClickedContext:o,_eventClickedContext:l}=s,{eventStore:c,assignmentStore:d}=n;arguments.length===0&&(o?(e=o.date,r=o.resourceRecord):s._focusedEventOnCopy!==l&&(e=l.eventRecord.startDate,r=l.resourceRecord)),r&&(r=r.$original);const u=await s.readFromClipboard({resourceRecord:r,date:e});if(!((t=u==null?void 0:u.assignmentRecords)!=null&&t.length))return;const{assignmentRecords:h,eventRecords:p}=u;let C=null;const D=new Set,T=[];for(const y of h){let{event:R}=y;const S=r||y.resource,Y=e||y.event.startDate;if(D.has(R)){a&&y.remove();continue}if(D.add(R),a)y.meta.isCut=!1,y.resource=S,C=y;else if(!c.usesResourceIds&&(c.usesSingleAssignment||s.copyPasteAction==="clone"))R=R.copy(),R.name=s.generateNewName(R),c.add(R),R.assign(S),C=d.last;else if(!R.resources.includes(S)){const B=y.copy();B.resource=S,[C]=d.add(B)}R.startDate=Y,R.constraintDate&&(R.constraintDate=null),T.push(R)}n.trigger("paste",{assignmentRecords:h,pastedEventRecords:T,eventRecords:p,resourceRecord:r,date:e,isCut:a,entityName:i});const F=n.ion({renderEvent({assignmentRecord:y}){y===C&&(n.navigateTo(y,{scrollIntoView:!1}),F())}});a&&await s.clearClipboard()}async beforePaste({data:{assignmentRecords:e,eventRecords:r},resourceRecord:t,isCut:s,date:n}){const{scheduler:i}=this,a={assignmentRecords:e,eventRecords:r,resourceRecord:t||e[0].resource,date:n,isCut:s,entityName:this.entityName};let o;return t!=null&&t.readOnly&&(o="resourceReadOnly"),i.allowOverlap||e.some(c=>!i.isDateRangeAvailable(c.event.startDate,c.event.endDate,s?c.event:null,c.resource))&&(o="overlappingEvents"),o?(i.trigger("pasteNotAllowed",{...a,reason:o}),!1):await this.scheduler.trigger("beforePaste",a)}stringParser(e){const{eventStore:r,assignmentStore:t}=this.scheduler,{modifiedRecords:s}=this.setFromStringData(e,!0,r,this.eventToStringFields),n=[];for(const i of s){const a=new t.modelClass({eventId:i.id});a.event=i,n.push(a)}return{eventRecords:s,assignmentRecords:n}}populateEventMenu({assignmentRecord:e,items:r}){const t=this,{scheduler:s}=t;s.readOnly||(r.copyEvent={text:"L{copyEvent}",localeClass:t,icon:"b-icon b-icon-copy",weight:110,onItem:()=>{const n=s.isAssignmentSelected(e)?s.selectedAssignments:[e];t.copyEvents(n)}},r.cutEvent={text:"L{cutEvent}",localeClass:t,icon:"b-icon b-icon-cut",weight:120,disabled:e.event.readOnly,onItem:()=>{const n=s.isAssignmentSelected(e)?s.selectedAssignments:[e];t.copyEvents(n,!0)}})}populateScheduleMenu({items:e,resourceRecord:r}){const t=this,{scheduler:s}=t;!s.readOnly&&t.hasClipboardData()!==!1&&(e.pasteEvent={text:"L{pasteEvent}",localeClass:t,icon:"b-icon b-icon-paste",disabled:s.resourceStore.count===0||r.readOnly,weight:110,onItem:({date:n,resourceRecord:i})=>{t.pasteEvents(n,i,s.getRowFor(i))}})}generateNewName(e){const r=e.getValue(this.nameField);let t=2;for(;this.client.eventStore.findRecord(this.nameField,`${r} - ${t}`);)t++;return`${r} - ${t}`}};v($,"$name","EventCopyPaste"),v($,"pluginConfig",{assign:["copyEvents","pasteEvents"],chain:["populateEventMenu","populateScheduleMenu","onEventDataGenerated"]}),v($,"configurable",{nameField:"name",copyPasteAction:"clone",eventToStringFields:["name","startDate","endDate","duration","durationUnit","allDay"]}),$.featureClass="b-event-copypaste",$._$name="EventCopyPaste",A.registerFeature($,!0,"Scheduler");var ie=class extends Be{static get $name(){return"EventDrag"}static get configurable(){return{constrainDragToResource:!1,constrainDragToTimeSlot:!1,externalDropTargetSelector:null,validatorFn:(e,r)=>{},validatorFnThisObj:null,unifiedDrag:null,snapToPosition:null,copyKey:"SHIFT",copyMode:"auto",mode:"move",capitalizedEventName:null}}afterConstruct(){this.capitalizedEventName=this.capitalizedEventName||this.client.capitalizedEventName,super.afterConstruct(...arguments)}changeMode(e){const{dragData:r,copyMode:t}=this;if((t==="event"||t==="auto"||t==="assignment"&&!this.scheduler.eventStore.usesSingleAssignment)&&(!r||r.eventRecords.every(s=>!s.isRecurring)))return e}updateMode(e){this.dragData&&(e==="copy"?this.setCopying():this.setMoving(),this.client.trigger("eventDragModeChange",{mode:e}))}setCopying(){const{dragData:e}=this;e&&(e.eventBarCopies.some(r=>r.isConnected)?e.eventBarCopies.forEach(r=>{r.classList.remove("b-hidden")}):e.eventBarCopies.forEach(r=>{r.classList.add("b-drag-proxy-copy"),r.classList.remove("b-hidden"),e.context.grabbedParent.appendChild(r),r.retainElement=!0}))}setMoving(){const{dragData:e}=this;e&&e.eventBarCopies.forEach(r=>{r.classList.add("b-hidden")})}get scheduler(){return this.client}onAfterDragStart(e){const r=this,{context:{element:t}}=e;super.onAfterDragStart(e),r.handleKeyDownOrMove(e.event),r.keyEventDetacher=ee.on({element:w.getRootElement(t),keydown:r.handleKeyDownOrMove,keyup:r.handleKeyUp,thisObj:r})}onDragReset(e){var r;super.onDragReset(e),(r=this.keyEventDetacher)==null||r.call(this),this.mode="move"}onDrop(e){var r;return(r=this.dragData.eventBarCopies)==null||r.forEach(t=>t.remove()),super.onDrop(e)}getDraggableElement(e){return e==null?void 0:e.closest(this.drag.targetSelector)}resolveEventRecord(e,r=this.client){return r.resolveEventRecord(e)}isElementDraggable(e,r){var t;const s=this,{client:n}=s,i=s.getDraggableElement(e);if(!i||s.disabled||n.readOnly||e.matches('[class$="-handle"]'))return!1;const a=s.resolveEventRecord(i,n);return!a||!a.isDraggable||a.readOnly?!1:!(((t=n[`is${s.capitalizedEventName}ElementDraggable`])==null?void 0:t.call(n,i,a,e,r))===!1)}getTriggerParams(e){const{assignmentRecords:r,eventRecords:t,resourceRecord:s,browserEvent:n}=e;return{context:e,eventRecords:t,resourceRecord:s,assignmentRecords:r,event:n,domEvent:n}}getGroupedToStoreResources(e){if(e.resourcesInStore)return e.resourcesInStore;const r=this.client,t=r.isVertical?r.resourceStore:r.store;return e.resourcesInStore=[...new Set(t.getAllDataRecords().map(s=>s.$original))].filter(s=>s.isLeaf)}getIndexDiff(e){const r=this,t=r.client,s=r.currentOverClient,n=t!==s,{isVertical:i}=s,a=t.isVertical?t.resourceStore:t.store,o=i?s.resourceStore:s.store,{resourceRecord:l,newResource:c}=e;let d;if(n)d=o.indexOf(c)-a.indexOf(l.$original);else if(r.constainDragToResource)d=0;else if(i&&o.isGrouped){const u=r.getGroupedToStoreResources(e);d=u.indexOf(l.$original)-u.indexOf(c)}else d=a.indexOf(l.$original)-a.indexOf(c);return d}getNewResource(e,r,t){const s=this,n=s.client,i=s.currentOverClient,a=n!==i,{isVertical:o}=i,l=n.isVertical?n.resourceStore:n.store,c=o?i.resourceStore:i.store;let{newResource:d}=e;if(a){const u=l.indexOf(r);d=c.getAt(u+t)||d}else if(t!==0){let u;if(o&&c.isGrouped){const h=s.getGroupedToStoreResources(e);u=Math.max(Math.min(h.indexOf(r)-t,h.length-1),0),d=h[u]}else u=Math.max(Math.min(l.indexOf(r)-t,l.count-1),0),d=l.getAt(u),d.isSpecialRow&&(d=l.getNext(d,!1,!0)||l.getPrevious(d,!1,!0));d=d==null?void 0:d.$original}else d=r;return d}getDropData(e){const r=this.getIndexDiff(e);return{events:e.eventRecords.map(t=>({eventRecord:t,...this.getEventNewStartEndDates(t,e.timeDiff)})),assignments:e.assignmentRecords.map(t=>({assignmentRecord:t,resourceRecord:this.getNewResource(e,t.resource,r)}))}}triggerBeforeEventDropFinalize(e,r,t){r.context.dropData=this.getDropData(r.context),super.triggerBeforeEventDropFinalize(e,r,t)}triggerBeforeEventDrag(e,r){return this.client.trigger(e,r)}triggerEventDrag(e,r){this.client.trigger("eventDrag",Object.assign(this.getTriggerParams(e),{startDate:e.startDate,endDate:e.endDate,newResource:e.newResource}))}triggerDragStart(e){this.client.navigator.skipNextClick=!0,this.client.trigger("eventDragStart",this.getTriggerParams(e))}triggerDragAbort(e){this.client.trigger("eventDragAbort",this.getTriggerParams(e))}triggerDragAbortFinalized(e){this.client.trigger("eventDragAbortFinalized",this.getTriggerParams(e))}triggerAfterDrop(e,r){const t=this;if(t.currentOverClient.trigger("afterEventDrop",Object.assign(t.getTriggerParams(e),{valid:r})),!r){const{assignmentStore:s,eventStore:n}=t.client;t.dragData.initialAssignmentsState.find(({resource:a,assignment:o},l)=>{var c;return!s.includes(o)||!n.includes(o.event)||a.id!==((c=t.dragData.assignmentRecords[l])==null?void 0:c.resourceId)})&&t.client.refresh()}t.client.setTimeout(()=>t.client.navigator.skipNextClick=!1,10)}handleKeyDownOrMove(e){var r,t;this.mode!=="copy"&&(e.key&&ee.specialKeyFromEventKey(e.key)===((r=this.copyKey)==null?void 0:r.toLowerCase())||e[`${(t=this.copyKey)==null?void 0:t.toLowerCase()}Key`])&&(this.mode="copy")}handleKeyUp(e){ee.specialKeyFromEventKey(e.key)===this.copyKey.toLowerCase()&&(this.mode="move")}isValidDrop(e){const{newResource:r,resourceRecord:t,browserEvent:s}=e,n=e.draggedEntities[0],{target:i}=s;return r?r.isSpecialRow||r.readOnly?!1:t.$original!==r?!n.event.resources.includes(r):!0:!this.constrainDragToTimeline&&this.externalDropTargetSelector?!!i.closest(this.externalDropTargetSelector):!1}checkDragValidity(e,r){var t,s,n;const i=this,a=i.currentOverClient;let o;return(t=e.newResource)!=null&&t.readOnly?!1:(!a.allowOverlap&&!a.isDateRangeAvailable(e.startDate,e.endDate,e.draggedEntities[0],e.newResource)?o={valid:!1,message:i.L("L{eventOverlapsExisting}")}:o=i.validatorFn.call(i.validatorFnThisObj||i,e,r),(!o||o.valid)&&(o=(n=(s=a.checkEventDragValidity)==null?void 0:s.call(a,e,r))!=null?n:o),o)}async updateRecords(e){const r=this,t=r.client,s=r.currentOverClient,n=r.mode==="copy",{draggedEntities:i,timeDiff:a,initialAssignmentsState:o}=e,l=o[0].startDate,c=r.adjustStartDate(l,a);let d;return e.externalDropTarget||(s.timeAxis.timeSpanInAxis(c,_.add(c,i[0].event.durationMS,"ms"))||(e.valid=!1),e.valid&&(t.eventStore.suspendAutoCommit(),s.eventStore.suspendAutoCommit(),d=await r.updateAssignments(t,s,e,n),t.eventStore.resumeAutoCommit(),s.eventStore.resumeAutoCommit())),e.valid&&s.trigger("eventDrop",Object.assign(r.getTriggerParams(e),{isCopy:n,copyMode:r.copyMode,domEvent:e.browserEvent,targetEventRecord:e.targetEventRecord,targetResourceRecord:e.newResource,externalDropTarget:e.externalDropTarget})),d}async updateAssignments(e,r,t,s){var n;const i=this,{copyMode:a}=i,o=e!==r,{isVertical:l}=r,{assignmentStore:c,eventStore:d}=e,{assignmentStore:u,eventStore:h}=r,p=e.isVertical?e.resourceStore:e.store,{eventRecords:C,assignmentRecords:D,timeDiff:T,initialAssignmentsState:F,newResource:y}=t,{unifiedDrag:R}=i,S=h.usesSingleAssignment||h.usesSingleAssignment!==!1&&d.usesSingleAssignment,Y=a==="event"?"event":a==="assignment"?"assignment":S?"event":"assignment",B=i.adjustStartDate(D[0].event.startDate,T),M=[],Z=[],O=[],V=[],le=[],q=new Set;e.suspendRefresh(),r.suspendRefresh();let L=!1,fe=!1,xe=i.getIndexDiff(t);l&&C.forEach((f,b)=>{const g=t.eventBarEls[b];delete f.instanceMeta(e).hasTemporaryDragElement,g.dataset.transient&&g.remove()});const ce=t.eventBarEls.slice(),I=[],re={};for(let f=0;f<D.length;f++){const b=D[f];let g=b.event,m;if(s?(m=b.copy(),re[b.id]=m):m=b,!m.isOccurrenceAssignment&&(!c.includes(b)||!d.includes(g))){ce[f].remove(),ce.splice(f,1),D.splice(f,1),f--;continue}const J=F[f],x=g,Q=J.startDate,z=J.resource,pe=this.constrainDragToTimeSlot?Q:R?B:i.adjustStartDate(Q,T);if(c!==u){const j=x.assignments.length>1||s;let E;s?E=m:(E=m.copy(),re[m.id]=E),E.event&&!S&&(E.event=E.event.id,E.resource=E.resource.id),s||V.push(m),j||Z.push(x),(s&&(a==="event"||a==="auto"&&h.usesSingleAssignment)||!h.getById(x.id))&&(g=h.createRecord({...x.data,children:(n=x.children)==null?void 0:n.map(Ae=>Ae.copy()),id:s&&(a==="event"||a==="auto")?void 0:x.id,calendar:null}),E.set({eventId:g.id,event:g}),M.push(g)),S||O.push(E),m=E}let H=y,ve=null;R||(H=i.getNewResource(t,z,xe)||y);const Re=m.resourceId!==H.$original.id;if(Re){if(ve=p.getById(m.resourceId),s&&c===u){m.setData({resource:null,resourceId:null}),m.resource=H,m.event=h.getById(m.eventId);const j=a==="event"||d.usesSingleAssignment&&a==="auto";j&&(g=g.copy(),g.meta.endDateCached=i.adjustStartDate(g.endDate,T),g.endDate=null,m.event=g,h.usesSingleAssignment&&(g.resource=H,g.resourceId=H.id)),!u.find(E=>E.eventId===m.eventId&&E.resourceId===m.resourceId)&&!O.find(E=>E.eventId===m.eventId&&E.resourceId===m.resourceId)&&(j&&M.push(g),O.push(m))}else m.resource=H;g.isEvent&&q.add(g),L=!0,g.isOccurrence&&g.set("newResource",H),o&&S&&(g.resourceId=H.id)}else s&&(a==="event"||a==="auto"&&d.usesSingleAssignment)&&!M.includes(g)&&(g=g.copy(),g.meta.endDateCached=i.adjustStartDate(g.endDate,T),g.endDate=null,M.push(g),m.event=g,h.usesSingleAssignment&&g.set({resource:H,resourceId:H.id}),O.push(m));if(!le.find(j=>j.draggedEvent===g)&&!_.isEqual(g.startDate,pe)){for(;!g.isOccurrence&&g.isBatchUpdating;)g.endBatch(!0);s&&!o&&!S&&Y==="assignment"&&Re||(g.startDate=pe,le.push({draggedEvent:g,originalStartDate:Q})),g.isEvent&&q.add(g),fe=!0}r.processEventDrop({eventRecord:g,resourceRecord:H,element:f===0?t.context.element:t.context.relatedElements[f-1],context:t,toScheduler:r,reassignedFrom:ve,eventsToAdd:M,addedEvents:I,draggedAssignment:m}),r.trigger("processEventDrop",{originalAssignment:b,draggedAssignment:m,context:t,copyMode:a,isCopy:s})}if(c.remove(V),d.remove(Z),u.add(O),s&&c===u){const{syncIdMap:f}=e.foregroundCanvas;Object.entries(re).forEach(([b,g])=>{const m=f[b];delete f[b],f[g.id]=m})}if(M.length&&I.push(...h.add(M)),I==null||I.forEach(f=>q.add(f)),(V.length||Z.length||O.length||M.length)&&(L=!0),(L||fe)&&(S&&q.forEach(f=>f.beginBatch()),await Promise.all([r.project!==e.project?r.project.commitAsync():null,e.project.commitAsync()]),S&&q.forEach(f=>f.endBatch(!1,!0))),L||(L=le.some(({draggedEvent:f,originalStartDate:b})=>!_.isEqual(f.startDate,b))),!i.constrainDragToTimeline&&L)for(let f=0;f<D.length;f++){const b=re[D[f].id]||D[f],g=b.event,m=(I==null?void 0:I.find(z=>z.id===g.id))||g,J=t.eventBarEls[f],x=f===0?t.context.element:t.context.relatedElements[f-1],Q=r.isInTimeAxis(m);if(delete m.meta.endDateCached,s||ge.removeChild(J.parentElement,J),m.resource&&(l||r.rowManager.getRowFor(m.resource))&&Q){if(!m.parent||m.parent.isRoot){const z=P.from(x,r.foregroundCanvas,!0);w.setTopLeft(x,z.y,z.x),ge.addChild(r.foregroundCanvas,x,m.assignments[0].id),o&&r.processCrossSchedulerEventDrop({eventRecord:m,toScheduler:r})}x.classList.remove("b-sch-event-hover","b-active","b-drag-proxy","b-dragging"),x.retainElement=!1}}r.resumeRefresh(!1),e.resumeRefresh(!1),D.length>0&&(L?(ce.forEach(f=>delete f.lastDomConfig),r.refreshWithTransition(),o&&(e.refreshWithTransition(),r.selectedEvents=I)):t.valid=!1)}getProductDragContext(e){const r=this,{currentOverClient:t}=r,s=e.browserEvent.target,n=e.newResource||e.resourceRecord,i=e.targetEventRecord;let a=t?r.resolveEventRecord(s,t):null,o,l;e.eventRecords.includes(a)&&(a=null),r.constrainDragToResource?o=e.resourceRecord:r.constrainDragToTimeline?t&&(o=r.resolveResource()||e.newResource||e.resourceRecord):o=r.resolveResource();const{assignmentRecords:c,eventRecords:d}=e,u=n!==o;let h=!!(o&&!o.isSpecialRow);return!o&&r.externalDropTargetSelector&&(l=s.closest(r.externalDropTargetSelector),h=!!l),{valid:h,externalDropTarget:l,eventRecords:d,assignmentRecords:c,newResource:o,targetEventRecord:a,dirty:u||a!==i,proxyElements:[e.context.element,...e.context.relatedElements||[]]}}getMinimalDragData(e){const r=this,{scheduler:t}=r,s=r.getElementFromContext(e),n=r.resolveEventRecord(s,t),i=t.resolveResourceRecord(s),a=t.resolveAssignmentRecord(s),o=a?[a]:[];a&&(t.isAssignmentSelected(o[0])||r.drag.startEvent.ctrlKey&&t.multiEventSelect)&&o.push.apply(o,r.getRelatedRecords(a));const l=[...new Set(o.map(c=>c.event))];return{eventRecord:n,resourceRecord:i,assignmentRecord:a,eventRecords:l,assignmentRecords:o}}setupProductDragData(e){var r;const t=this,{scheduler:s}=t,n=t.getElementFromContext(e),{eventRecord:i,resourceRecord:a,assignmentRecord:o,assignmentRecords:l}=t.getMinimalDragData(e),c=[];if(t.constrainDragToResource&&!a)throw new Error("Resource could not be resolved for event: "+i.id);let d;if(t.constrainDragToTimeline){d=(r=t.getDateConstraints)==null?void 0:r.call(t,a,i);const u=t.constrainRectangle=t.getConstrainingRectangle(d,a,i),h=P.from(n,s.timeAxisSubGridElement);super.setupConstraints(u,h,s.timeAxisViewModel.snapPixelAmount,!!d.start)}return l.forEach(u=>{let h=s.getElementFromAssignmentRecord(u,!0);h||(h=s.currentOrientation.addTemporaryDragElement(u.event,u.resource)),c.push(h)}),{record:o,draggedEntities:l,dateConstraints:d!=null&&d.start?d:null,eventBarCopies:c.map(u=>t.createProxy(u)),eventBarEls:c}}getDateConstraints(e,r){var t;const{scheduler:s}=this,n=(t=s.getDateConstraints)==null?void 0:t.call(s,e,r);let i,a;return this.constrainDragToTimeSlot?(i=r.startDate,a=r.endDate):n&&(i=n.start,a=n.end),{start:i,end:a}}getConstrainingRectangle(e,r,t){return this.scheduler.getScheduleRegion(this.constrainDragToResource&&r,t,!0,e&&{start:e.start,end:e.end})}getDragData(e){const r=this.getMinimalDragData(e)||{};return{...super.getDragData(e),...r,initialAssignmentsState:r.assignmentRecords.map(t=>({startDate:t.event.startDate,resource:t.resource,assignment:t}))}}getRelatedRecords(e){return this.scheduler.selectedAssignments.filter(r=>r!==e&&!r.resource.readOnly&&r.event.isDraggable)}getCoordinate(e,r,t){const s=this.currentOverClient;if(s.isHorizontal){let n=t[0];if(s.milestoneLayoutMode!=="default"&&e.isMilestone)switch(s.milestoneAlign){case"center":n+=r.offsetWidth/2;break;case"end":n+=r.offsetWidth;break}return n}else{let n=t[1];if(s.milestoneLayoutMode!=="default"&&e.isMilestone)switch(s.milestoneAlign){case"center":n+=r.offsetHeight/2;break;case"end":n+=r.offsetHeight;break}return n}}resolveResource(){const e=this,r=e.currentOverClient,{isHorizontal:t}=r,{context:s,browserEvent:n,dragProxy:i}=e.dragData,a=i||s.element,o=P.from(a,null,!0),l=r.isVertical||e.unifiedDrag?s.clientY:o.center.y,c=P.from(a,r.timeAxisSubGridElement,!0),{x:d,y:u}=c.center,h=e.getMouseMoveEventTarget(n);let p=null;if(r.element.contains(h))if(t){const C=r.rowManager.getRowAt(l);p=C&&r.store.getAt(C.dataIndex)}else p=r.resolveResourceRecord(r.timeAxisSubGridElement.querySelector(".b-sch-timeaxis-cell"),[d,u]);return p==null?void 0:p.$original}adjustStartDate(e,r){const t=this.currentOverClient;return e=t.timeAxis.roundDate(new Date(e-0+r),t.snapRelativeToEventStartDate?e:!1),this.constrainStartDate(e)}getRecordElement(e){return this.client.getElementFromAssignmentRecord(e,!0)}getProxyElement(e){var r;const{dragData:t}=this;if(this.isDragging&&((r=t.proxyElements)!=null&&r.length)){const s=t.assignmentRecords.indexOf(e);if(s>=0)return t.proxyElements[s]}return null}getMouseMoveEventTarget(e){return e.target}};ie._$name="EventDrag",A.registerFeature(ie,!0,"Scheduler"),A.registerFeature(ie,!1,"ResourceHistogram");var X=class extends Oe{get scheduler(){return this.client}get store(){return this.client.eventStore}get project(){return this.client.project}updateLockLayout(e){this.dragActiveCls=`b-dragcreating${e?" b-dragcreate-lock":""}`}handleBeforeDragCreate(e,r,t){var s;const{resourceRecord:n}=e;if(this.disabled||n.readOnly||!this.scheduler.resourceStore.isAvailable(n))return!1;const{scheduler:i}=this,a=!i.isSchedulerPro||r.ignoreResourceCalendar||n.isWorkingTime(e.mousedownDate),o=a&&i.trigger("beforeDragCreate",{resourceRecord:n,date:e.mousedownDate,event:t});return this.dateConstraints=(s=i.getDateConstraints)==null?void 0:s.call(i,n,r),o}dragStart(e){var r;const t=this,{client:s}=t,{eventStore:n,assignmentStore:i,enableEventAnimations:a,enableTransactionalFeatures:o}=s,{resourceRecord:l}=e,c=t.createEventRecord(e),d=[l];if(c.set("duration",_.diff(c.startDate,c.endDate,c.durationUnit,!0)),c.isCreating=!0,c.meta.isDragCreating=!0,s.features.taskEdit&&s.features.taskEdit.doCancel(),t.handleBeforeDragCreate(e,c,e.event)===!1)return!1;t.captureStm(!0);let u=[];return l&&(n.usesSingleAssignment||!o?u=i.assignEventToResource(c,l):u=[i.createRecord({event:c,resource:l})]),s.trigger("beforeEventAdd",{eventRecord:c,resourceRecords:d,assignmentRecords:u})===!1?((n.usesSingleAssignment||!o)&&i.remove(u),!1):(t.lockLayout&&(c.meta.excludeFromLayout=!0),(r=s.onEventCreated)==null||r.call(s,c),s.enableEventAnimations=!1,n.addAsync(c).then(()=>s.enableEventAnimations=a),!n.usesSingleAssignment&&o&&i.add(u[0]),s.isCreating=!0,s.refreshRows(),s.isCreating=!1,e.itemElement=e.element=s.getElementFromEventRecord(c),w.isInView(e.itemElement)||s.scrollable.scrollIntoView(e.itemElement,{animate:!0,edgeOffset:s.barMargin}),super.dragStart(e))}checkValidity(e,r){const t=this,{client:s}=t;return e.resourceRecord=t.dragging.resourceRecord,(s.allowOverlap||s.isDateRangeAvailable(e.startDate,e.endDate,e.eventRecord,e.resourceRecord))&&t.createValidatorFn.call(t.validatorFnThisObj||t,e,r)}isRowEmpty(e){const r=this.store.getEventsForResource(e);return!r||!r.length}triggerBeforeFinalize(e){this.client.trigger("beforeDragCreateFinalize",e)}createEventRecord(e){const r=this,{client:t}=r,s=t.isHorizontal?"X":"Y",{timeAxis:n,eventStore:i,weekStartDay:a}=t,{event:o,mousedownDate:l}=e,c=r.draggingEnd=o[`page${s}`]>e.startEvent[`page${s}`],d={name:i.modelClass.fieldMap.name.defaultValue||r.L("L{Object.newEvent}"),startDate:c?_.floor(l,n.resolution,null,a):l,endDate:c?l:_.ceil(l,n.resolution,null,a)};return t.project.isGanttProjectMixin&&W.assign(d,{constraintDate:d.startDate,constraintType:"startnoearlierthan"}),i.createRecord(d)}async internalUpdateRecord(e,r){await super.internalUpdateRecord(e,r),this.client.hasEventEditor||(e.eventRecord.isCreating=!1)}async finalizeDragCreate(e){const{meta:r}=e.eventRecord;r.excludeFromLayout=!1,r.isDragCreating=!1;const t=await super.finalizeDragCreate(e);return t?this.hasStmCapture=!1:await this.freeStm(!0),t}async cancelDragCreate(e){await super.cancelDragCreate(e),await this.freeStm(!1)}getTipHtml(...e){const r=super.getTipHtml(...e),{element:t}=this.tip;return t.classList.add("b-sch-dragcreate-tooltip"),t.classList.toggle("b-too-narrow",this.dragging.context.tooNarrow),r}onAborted(e){var r,t;const{eventRecord:s,resourceRecord:n}=e;(t=(r=this.store).unassignEventFromResource)==null||t.call(r,s,n),this.store.remove(s)}};v(X,"$name","EventDragCreate"),v(X,"configurable",{validatorFn:()=>!0}),X._$name="EventDragCreate",A.registerFeature(X,!0,"Scheduler"),A.registerFeature(X,!1,"ResourceHistogram");var be=[0,0],Ue=[null,[0,10],[10,0]],ae=class extends _e{static get $name(){return"EventTooltip"}static get defaultConfig(){return{template:e=>`
                ${e.eventRecord.name?ye.xss`<div class="b-sch-event-title">${e.eventRecord.name}</div>`:""}
                ${e.startClockHtml}
                ${e.endClockHtml}`,cls:"b-sch-event-tooltip",monitorRecordUpdate:!0,scrollAction:"hide"}}construct(e,r){super.construct(e,r),typeof this.align=="string"&&(this.align={align:this.align})}onInternalPaint({firstPaint:e}){if(super.onInternalPaint(...arguments),e){const{dependencies:r}=this.client.features;r&&this.tooltip.ion({beforeAlign({source:t,offset:s=be}){const{edgeAligned:n}=ze(t.align.align),i=r.disabled||!r.allowCreate?be:Ue[n];arguments[0].offset=[s[0]+i[0],s[1]+i[1]]}})}}};ae._$name="EventTooltip",A.registerFeature(ae,!0,"Scheduler"),A.registerFeature(ae,!1,"ResourceHistogram");var Ke={width:0,height:0},G=class extends se{construct(e,r){super.construct(e,r),e.isVertical&&(this.toUpdate=new Set,e.ion({scroll:"onSchedulerScroll",horizontalScroll:"onHorizontalScroll",thisObj:this,prio:1e4}))}onEventDataGenerated(e){this.client.isHorizontal?e.wrapperCls["b-disable-sticky"]=e.eventRecord.stickyContents===!1:(this.syncEventContentPosition(e,void 0,!0),this.updateStyles())}onSchedulerScroll(){this.disabled||this.verticalSyncAllEventsContentPosition(this.client)}onHorizontalScroll({subGrid:e}){e===this.client.timeAxisSubGrid&&this.verticalSyncAllEventsContentPosition(this.client)}updateStyles(){for(const{contentEl:e,style:r}of this.toUpdate)w.applyStyle(e,r);this.toUpdate.clear()}verticalSyncAllEventsContentPosition(e){const{resourceMap:r}=e.currentOrientation;for(const t of r.values())for(const{renderData:s,elementConfig:n}of Object.values(t)){const i=[s];n&&s.eventRecord.isResourceTimeRange&&i.push(n.children[0]),this.syncEventContentPosition.apply(this,i)}this.toUpdate.size&&this.updateStyles()}syncEventContentPosition(e,r=e.eventContent,t=!1){if(this.disabled||e.eventRecord.stickyContents===!1)return;const{client:s}=this,{eventRecord:n,resourceRecord:i,useEventBuffer:a,bufferAfterWidth:o,bufferBeforeWidth:l,top:c,height:d}=e,u=s.scrollable.y,h=t?null:s.getElementFromEventRecord(n,i,!0),p=h&&ge.getChild(h,"event.content"),C=n.instanceMeta(s),D=typeof r.style=="string"?r.style=w.parseStyle(r.style):r.style||(r.style={});if(h!=null&&h.classList.contains("b-dragging"))return;let T=c,F=d,y=T+F;if(a&&(T+=l,F=F-l-o,y=T+F),T<u&&y>=u&&!n.isMilestone){const R=p==null?void 0:p.offsetWidth,S=(p==null?void 0:p.parentNode)&&w.getStyleValue(p.parentNode,"justifyContent"),Y=S==="center"?(e.width-R)/2:0,B=T,M=B+F-1;if((!p||R)&&B<u&&M>=u){const Z=this.getEventContentMargins(p),O=p?F-p.offsetHeight-Z.height-Y:Number.MAX_SAFE_INTEGER,V=Math.min(u-B,O-2);D.transform=V>0?`translateY(${V}px)`:"",C.stuck=!0}else D.transform="",C.stuck=!1;p&&this.toUpdate.add({contentEl:p,style:D})}else p&&C.stuck&&(D.transform="",C.stuck=!1,this.toUpdate.add({contentEl:p,style:D}))}getEventContentMargins(e){return e!=null&&e.classList.contains("b-sch-event-content")?w.getEdgeSize(e,"margin"):Ke}doDisable(){super.doDisable(...arguments),this.isConfiguring||this.client.refreshWithTransition()}};v(G,"$name","StickyEvents"),v(G,"type","stickyEvents"),v(G,"pluginConfig",{chain:["onEventDataGenerated"]}),G._$name="StickyEvents",A.registerFeature(G,!0,"Scheduler"),A.registerFeature(G,!1,"ResourceHistogram");var oe=class extends Me.mixin(de){static get $name(){return"TimeRanges"}static get defaultConfig(){return{store:!0}}doDestroy(){var e;(e=this.storeDetacher)==null||e.call(this),super.doDestroy()}get timeRanges(){const e=this;if(!e._timeRanges){const{store:r}=e;let{records:t}=r;if(r.recurringEvents){const{startDate:s,endDate:n}=e.client.timeAxis;t=t.flatMap(i=>i.isRecurring?i.getOccurrencesForDateRange(s,n):i)}e.currentTimeLine&&(r.recurringEvents||(t=t.slice()),t.push(e.currentTimeLine)),e._timeRanges=t}return e._timeRanges}attachToProject(e){var r,t;super.attachToProject(e);const s=this;(r=s.projectTimeZoneChangeDetacher)==null||r.call(s),s.showCurrentTimeLine&&(s.projectTimeZoneChangeDetacher=(t=s.client.project)==null?void 0:t.ion({timeZoneChange:()=>s.updateCurrentTimeLine()}),s.currentTimeLine&&s.updateCurrentTimeLine())}initCurrentTimeLine(){const e=this;if(e.currentTimeLine||!e.showCurrentTimeLine)return;const r=typeof e.showCurrentTimeLine=="object"?e.showCurrentTimeLine:{};e.currentTimeLine=e.store.modelClass.new({id:"currentTime",cls:"b-sch-current-time"},r),e.currentTimeInterval=e.setInterval(()=>e.updateCurrentTimeLine(),e.currentTimeLineUpdateInterval),e._timeRanges=null,e.updateCurrentTimeLine()}updateCurrentTimeLine(){var e;const r=this,{currentTimeLine:t}=r;t.timeZone=(e=r.project)==null?void 0:e.timeZone,t.setLocalDate("startDate",new Date),t.endDate=t.startDate,t.originalData.name||(t.name=_.format(t.startDate,r.currentDateFormat)),r.renderRanges()}hideCurrentTimeLine(){const e=this;e.currentTimeLine&&(e.clearInterval(e.currentTimeInterval),e.currentTimeLine=null,e.refresh())}updateShowCurrentTimeLine(e){e?this.initCurrentTimeLine():this.hideCurrentTimeLine()}populateTimeAxisHeaderMenu({items:e}){e.currentTimeLine={weight:400,text:this.L("L{showCurrentTimeLine}"),checked:this.currentTimeLine,onToggle:({checked:r})=>{this.showCurrentTimeLine?this.updateShowCurrentTimeLine(r):this.showCurrentTimeLine=r}}}attachToStore(e){const r=this;let t=!1;r.storeDetacher&&(r.storeDetacher(),t=!0),r.storeDetacher=e.ion({change:"onStoreChange",refresh:"onStoreChange",thisObj:r}),r._timeRanges=null,t&&r.renderRanges()}get store(){return this.client.project.timeRangeStore}updateStore(e){const r=this,{client:t}=r,{project:s}=t;e=s.timeRangeStore,r.attachToStore(e),t.timeRanges&&!t._timeRangesExposed&&(e.add(t.timeRanges),delete t.timeRanges)}attachToTimeRangeStore(e){this.store=e}resolveTimeRangeRecord(e){const r=e.closest(this.baseSelector).dataset.id;return r==="currentTime"?this.currentTimeLine:this.store.getById(r)}onStoreChange({type:e,action:r}){const t=this;t._timeRanges=null,!(t.disabled||!t.client.isVisible||t.isConfiguring||e==="refresh"&&r!=="batch")&&t.client.runWithTransition(()=>t.renderRanges(),!t.client.refreshSuspended)}onDragStart(e){const r=this,{context:t}=e,s=r.resolveTimeRangeRecord(t.element.closest(r.baseSelector)),n=r.getBodyElementByRecord(s);t.relatedElements=[n],Object.assign(t,{record:s,rangeBodyEl:n,originRangeX:w.getTranslateX(n),originRangeY:w.getTranslateY(n)}),super.onDragStart(e),r.showTip(t)}onDrop(e){const{context:r}=e;if(!r.valid)return this.onInvalidDrop({context:r});const t=this,{client:s}=t,{record:n}=r,i=P.from(r.rangeBodyEl),a=s.getDateFromCoordinate(i.getStart(s.rtl,s.isHorizontal),"round",!1);n.startDate-a!==0?n.setStartDate(a):t.drag.abort(),t.destroyTip(),super.onDrop(e)}onResizeStart({context:e}){const r=this,t=r.resolveTimeRangeRecord(e.element.closest(r.baseSelector)),s=r.getBodyElementByRecord(t);Object.assign(e,{record:t,rangeBodyEl:s}),r.showTip(e),super.onResizeStart(...arguments)}onResizeDrag({context:e}){const r=this,{rangeBodyEl:t}=e,{client:s}=r,n=P.from(e.element),i=n.getStart(s.rtl,s.isHorizontal),a=n.getEnd(s.rtl,s.isHorizontal),o=s.getDateFromCoordinate(i,"round",!1),l=s.getDateFromCoordinate(a,"round",!1);r.client.isVertical?(e.edge==="top"&&w.setTranslateY(t,e.newY),t.style.height=e.newHeight+"px"):(e.edge==="left"&&w.setTranslateX(t,e.newX),t.style.width=e.newWidth+"px"),r.updateDateIndicator({startDate:o,endDate:l})}onResize({context:e}){if(!e.valid)return this.onInvalidDrop({context:e});const r=this,{client:t}=r,{rtl:s}=t,n=e.record,i=P.from(e.element),a=i.getStart(s,t.isHorizontal),o=i.getEnd(s,t.isHorizontal),l=t.getDateFromCoordinate(a,"round",!1),c=s&&e.edge==="right"||!s&&e.edge==="left"||e.edge==="top",d=t.getDateFromCoordinate(o,"round",!1);(c&&n.startDate-l!==0||d&&n.endDate-d!==0)&&d>l?c?n.setStartDate(l,!1):n.setEndDate(d,!1):r.onInvalidResize({context:e}),r.destroyTip()}onInvalidResize({context:e}){const r=this;r.resize.reset(),e.rangeBodyEl.parentElement.lastDomConfig=e.rangeBodyEl.lastDomConfig=e.element.lastDomConfig=null,r.renderRanges(),r.destroyTip()}};v(oe,"configurable",{store:{modelClass:je},currentTimeLineUpdateInterval:1e4,currentDateFormat:"HH:mm",showCurrentTimeLine:!1}),oe._$name="TimeRanges",A.registerFeature(oe,!1,["TimelineBase"]);var Se=e=>{var r;return r=class extends(e||De){static get properties(){return{recordsToRefresh:new Set}}beforeRenderRow({record:t}){var s;return(s=this.recordIsReadyForRendering)!=null&&s.call(this,t)&&this.unscheduleRecordRefresh(t),super.beforeRenderRow(...arguments)}cleanupScheduledRecord(){const{rowManager:t,store:s}=this;for(const n of[...this.recordsToRefresh])(!n.stores.includes(s)||!t.getRowById(n))&&this.recordsToRefresh.delete(n)}renderScheduledRecords(){const t=this;if(t.refreshSuspended)t.scheduleRecordRefresh();else{t.cleanupScheduledRecord();const{rowManager:s}=t,n=[...t.recordsToRefresh],i=n.map(a=>s.getRowById(a));i.length&&(s.renderRows(i),t.trigger("scheduledRecordsRender",{records:n,rows:i})),t.recordsToRefresh.size&&t.scheduleRecordRefresh()}}unscheduleRecordRefresh(t=!0){const s=this;t===!0?s.recordsToRefresh.clear():t&&ue.asArray(t).forEach(n=>s.recordsToRefresh.delete(n)),s.scheduledRecordsRefreshTimer&&!s.recordsToRefresh.size&&s.clearTimeout(s.scheduledRecordsRefreshTimer)}scheduleRecordRefresh(t){const s=this;t&&ue.asArray(t).forEach(n=>s.recordsToRefresh.add(n)),s.scheduledRecordsRefreshTimer=s.setTimeout({fn:"renderScheduledRecords",delay:s.scheduledRecordsRefreshTimeout,cancelOutstanding:!0})}get widgetClass(){}},v(r,"$name","DelayedRecordsRendering"),v(r,"configurable",{scheduledRecordsRefreshTimeout:10}),r},me=class extends De{construct(e){super.construct(),this.client=e}init(){}onTimeAxisViewModelUpdate(){const{scrollable:e}=this.client.timeAxisSubGrid;this.updateFromHorizontalScroll(e.x)}updateFromHorizontalScroll(e){const r=this,{client:t,scrollBuffer:s}=r,{timeAxisSubGrid:n,timeAxis:i,rtl:a}=t,{width:o}=n,{totalSize:l}=t.timeAxisViewModel,c=e,d=n.scrollable.maxX!==0&&Math.abs(n.scrollable.maxX)<=Math.round(c)+5,u=t.getDateFromCoord({coord:Math.max(0,c-s),ignoreRTL:!0}),h=d?i.endDate:t.getDateFromCoord({coord:c+o+s,ignoreRTL:!0})||i.endDate;if(u&&!t._viewPresetChanging){r._visibleDateRange={startDate:u,endDate:h,startMS:u.getTime(),endMS:h.getTime()},r.viewportCoords=a?{left:l-e-o+s,right:l-e-s}:{left:e-s,right:e+o+s};const p=t.timeView.range={startDate:u,endDate:h};if(t.internalOnVisibleDateRangeChange(p),!t.refreshSuspended&&t.rowManager.rows.length){if(t.rowManager.rows[0].id===null)return;(r._timeAxisStartDate-i.startDate||r._timeAxisEndDate-i.endDate)&&(r._timeAxisStartDate=i.startDate,r._timeAxisEndDate=i.endDate,t.rowManager.renderRows(t.rowManager.rows))}}}onViewportResize(){}refreshRows(){}get visibleDateRange(){return this._visibleDateRange}translateToPageCoordinate(e){const{client:r}=this,{scrollable:t}=r.timeAxisSubGrid;let s=e+r.timeAxisSubGridElement.getBoundingClientRect().left;return r.rtl?s-=t.maxX-Math.abs(r.scrollLeft):s-=r.scrollLeft,s}translateToScheduleCoordinate(e){const{client:r}=this,{scrollable:t}=r.timeAxisSubGrid;let s=e-r.timeAxisSubGridElement.getBoundingClientRect().left-globalThis.scrollX;return r.rtl?s+=t.maxX-Math.abs(r.scrollLeft):s+=r.scrollLeft,s}getDateFromXY(e,r,t,s=!1){const{client:n}=this;let i=e[0];return t||(i=this.translateToScheduleCoordinate(i)),i=n.getRtlX(i),n.timeAxisViewModel.getDateFromPosition(i,r,s)}};v(me,"configurable",{scrollBuffer:0}),me._$name="TimelineHistogramRendering";var Xe={series:null,topValue:null},Ye=()=>{},k=class extends Pe.mixin(Se){static get properties(){return{histogramDataByRecord:new Map,collectingDataFor:new Map}}updateGetRecordData(e){this._getRecordData=e?this.resolveCallback(e):null}updateHardRefreshOnTimeAxisReconfigure(e){const r="hardRefreshOnTimeAxisReconfigure";e?this.timeAxis.ion({name:r,endReconfigure:"onTimeAxisEndReconfigure",thisObj:this}):this.detachListeners(r)}construct(e){super.construct(e);const r=this;r.scheduleRefreshRows=r.createOnFrame(r.refreshRows,[],r,!0),r.rowManager.ion({beforeRowHeight:"onBeforeRowHeight",thisObj:r})}onDestroy(){var e;this.clearHistogramDataCache(),(e=this._histogramWidget)==null||e.destroy(),this.barTooltip=null}resolveTimeSpanRecord(e){}getScheduleMouseEventParams(e,r){return{record:this.store.getById(e.id)}}get currentOrientation(){return this._currentOrientation||(this._currentOrientation=new me(this)),this._currentOrientation}updateSeries(e){const r=this;r.histogramWidget.series=e,r._series=r.histogramWidget.series,r.isPainted&&!r.isConfiguring&&r.scheduleRefreshRows()}getAsyncEventSuffixForStore(e){return e.isAbstractPartOfProjectStoreMixin?"PreCommit":""}scheduleRefreshRows(){}getRowHeight(){return this.rowHeight}onInternalPaint({firstPaint:e}){super.onInternalPaint({firstPaint:e}),e&&this.showBarTip&&(this.barTooltip={})}updateGetBarTip(e){return e&&(this.barTooltipTemplate=null),e}changeBarTooltip(e,r){return r==null||r.destroy(),e?e.isTooltip?e:this.barTooltipClass.new({forElement:this.timeAxisSubGridElement,forSelector:".b-histogram rect",hoverDelay:0,trackMouse:!1,cls:"b-celltooltip-tip",getHtml:this.getTipHtml.bind(this)},this.showBarTip,e):null}async getTipHtml(e){if(this.showBarTip&&this.barTooltipTemplate){const{activeTarget:r}=e,t=parseInt(r.dataset.index,10),s=this.getRecordFromElement(r),n=await this.getRecordHistogramData(s);return this.barTooltipTemplate({...e,datum:this.extractHistogramDataArray(n,s)[t],record:s,index:t})}}collectTicksWidth(){const{ticks:e}=this.timeAxis,r=e[0].endDate-e[0].startDate,t={0:r};let s=r,n=!0;for(let i=1,{length:a}=e;i<a;i++){const o=e[i],l=o.endDate-o.startDate;r!==l&&(n=!1),s+=l,t[i]=l}if(n)this.ticksWidth=null;else{const i={};for(let a=0,{length:o}=e;a<o;a++)i[a]=t[a]/s;this.ticksWidth=i}}changeHistogramWidget(e){var r;const t=this;return e&&!e.isHistogram&&(t.getBarTextRenderData&&!e.getBarTextRenderData&&(e.getBarTextRenderData=t.getBarTextRenderData),e=t.histogramWidgetClass.new({owner:t,appendTo:t.element,height:t.rowHeight,width:((r=t.timeAxisColumn)==null?void 0:r.width)||0,getBarTip:!t.barTooltipTemplate&&t.getBarTip||Ye,getRectClass:t.getRectClass||t.getRectClassDefault,getBarText:t.getBarText||t.getBarTextDefault,getOutlineClass:t.getOutlineClass,getRectConfig:t.getRectConfig},e),e.suspendRefresh(),t.getBarTextDefault=t.getBarTextDefault.bind(e)),e}getRectClassDefault(e,r,t){}getBarTextDefault(e,r){}updateShowBarTip(e){this.barTooltip=e}get columns(){return super.columns}set columns(e){const r=this;super.columns=e,r.isDestroying||(r.timeAxisColumn.renderer=r.histogramRenderer.bind(r),r.timeAxisColumn.cellCls=r.timeAxisColumnCellCls)}onHistogramDataCacheSet({record:e,data:r}){this.scheduleRecordRefresh(e)}onTimeAxisEndReconfigure(){this.hardRefreshOnTimeAxisReconfigure&&(this.clearHistogramDataCache(),this.scheduleRefreshRows())}onStoreUpdateRecord({record:e,changes:r}){const t=this;return!t.getRecordData&&t.dataModelField&&r[t.dataModelField]&&t.clearHistogramDataCache(e),super.onStoreUpdateRecord(...arguments)}onStoreRemove({records:e}){super.onStoreRemove(...arguments);for(const r of e)this.clearHistogramDataCache(r)}onBeforeRowHeight({height:e}){if(this._timeAxisColumn){const r=this._histogramWidget;r&&(r.height=e,r.onElementResize(r.element))}}onTimeAxisViewModelUpdate(){super.onTimeAxisViewModelUpdate(...arguments);const e=this._histogramWidget;e&&(e.width=this.timeAxisViewModel.totalSize,e.onElementResize(e.element)),this.collectTicksWidth()}extractHistogramDataArray(e,r){return e}processRecordRenderData(e){return e}clearHistogramDataCache(e){e?this.histogramDataByRecord.delete(e):this.histogramDataByRecord.clear()}setHistogramDataCache(e,r){const t={record:e,data:r};this.trigger("beforeHistogramDataCacheSet",t),this.histogramDataByRecord.set(t.record,t.data),this.trigger("histogramDataCacheSet",t)}getHistogramDataCache(e){return e?this.histogramDataByRecord.get(e):this.histogramDataByRecord}hasHistogramDataCache(e){return this.histogramDataByRecord.has(e)}finalizeDataRetrievingInternal(e,r){return this.collectingDataFor.delete(e),this.setHistogramDataCache(e,r),r}finalizeDataRetrieving(e,r){return N.isPromise(r)?(this.collectingDataFor.set(e,r),r.then(t=>this.finalizeDataRetrievingInternal(e,t))):this.finalizeDataRetrievingInternal(e,r)}getRecordHistogramData(e){const r=this,{getRecordData:t}=r;let s=r.collectingDataFor.get(e)||r.getHistogramDataCache(e);return!s&&!r.hasHistogramDataCache(e)&&(t?s=t.handler.call(t.thisObj,...arguments):s=e.get(r.dataModelField),s=r.finalizeDataRetrieving(e,s)),s}recordIsReadyForRendering(e){return!this.collectingDataFor.has(e)}beforeRenderRow(e){const r=this,t=r.getRecordHistogramData(e.record);if(!N.isPromise(t)){const s=t?r.extractHistogramDataArray(t,e.record):[];if(!s)return;if(r.ticksWidth)for(let i=0,{length:a}=s;i<a;i++)s[i].width=r.ticksWidth[i];const n=N.merge({topValue:null},r.initialConfig.histogramWidget,{data:s,series:{...r.series}});e={...e,histogramConfig:n,histogramData:t,histogramWidget:r.histogramWidget},r.trigger("beforeRenderHistogramRow",e),delete e.eventName,delete e.source,delete e.type,delete e.oldId,delete e.row,delete e.recordIndex,r._recordRenderData=r.processRecordRenderData(e)}super.beforeRenderRow(...arguments)}applyHistogramWidgetConfig(e=this.histogramWidget,r){Object.assign(e,Xe,r)}renderRecordHistogram(e){const r=this,{histogramData:t,cellElement:s}=e;if(!t){s.innerHTML="";return}r.trigger("beforeRenderRecordHistogram",e),delete e.eventName,delete e.type,delete e.source;const n=e.histogramWidget||r.histogramWidget;r.applyHistogramWidgetConfig(n,e.histogramConfig),n.refresh({args:[e]});const i=n.element.cloneNode(!0);i.removeAttribute("id"),i.classList.remove("b-hide-offscreen"),s.innerHTML="",s.appendChild(i)}histogramRenderer(e){const r=this,t=e.histogramData||r.getRecordHistogramData(e.record);return N.isPromise(t)?"":(Object.assign(e,r._recordRenderData),r.renderRecordHistogram(...arguments))}buildGroupHeader(e){return e.column===this.timeAxisColumn?this.histogramRenderer(e):this.features.group.buildGroupHeader(e)}get widgetClass(){}};v(k,"$name","TimelineHistogramBase"),v(k,"type","timelinehistogrambase"),v(k,"configurable",{timeAxisColumnCellCls:"b-sch-timeaxis-cell b-timelinehistogram-cell",mode:"horizontal",rowHeight:50,showBarTip:!1,barTooltip:null,barTooltipClass:Ve,series:null,dataModelField:"histogramData",getRecordData:null,hardRefreshOnTimeAxisReconfigure:!0,getRectClass:null,getOutlineClass(e){return""},readOnly:!0,getBarTip:null,barTooltipTemplate:null,getBarText:null,getRectConfig:null,getBarTextRenderData:void 0,histogramWidgetClass:He,histogramWidget:{cls:"b-hide-offscreen b-timelinehistogram-histogram",omitZeroHeightBars:!0,data:[]},fixedRowHeight:!0}),k.initClass(),k._$name="TimelineHistogramBase";var Te=e=>{var r;return r=class extends(e||k){afterConfigure(){const t=this;t.internalAggregateDataEntry=t.internalAggregateDataEntry.bind(this),t.internalInitAggregatedDataEntry=t.internalInitAggregatedDataEntry.bind(this),super.afterConfigure(),t.features.treeGroup&&t.features.treeGroup.ion({beforeDataLoad:t.onTreeGroupBeforeDataLoad,thisObj:t})}updateAggregateFunctions(t){for(const[s,n]of Object.entries(t))if(n.id=s,n.aliases)for(const i of n.aliases)t[i]=n}updateStore(t){super.updateStore(...arguments),this.detachListeners("store"),t&&t.ion({name:"store",group:this.onStoreGroup,sort:this.onStoreSort,thisObj:this})}changeAggregateDataEntry(t){return this.bindCallback(t)}changeGetDataEntryForAggregating(t){return this.bindCallback(t)}changeInitAggregatedDataEntry(t){return this.bindCallback(t)}onHistogramDataCacheSet({record:t,data:s}){super.onHistogramDataCacheSet(...arguments),this.aggregateHistogramDataForGroups&&this.scheduleRecordParentsRefresh(t)}onTreeGroupBeforeDataLoad(){this.aggregateHistogramDataForGroups&&this.resetGeneratedRecordsHistogramDataCache()}onStoreGroup(){this.aggregateHistogramDataForGroups&&this.resetGeneratedRecordsHistogramDataCache()}onStoreSort({source:t}){this.aggregateHistogramDataForGroups&&t.isGrouped&&this.resetGeneratedRecordsHistogramDataCache()}getRecordHistogramData(t,s){const n=this;let i;return n.aggregateHistogramDataForGroups&&n.isGroupRecord(t)?(i=n.collectingDataFor.get(t)||n.getHistogramDataCache(t),!i&&!n.hasHistogramDataCache(t)&&(i=n.getGroupRecordHistogramData(t,s),i=n.finalizeDataRetrieving(t,i))):i=super.getRecordHistogramData(...arguments),i}internalAggregateDataEntry(t,...s){const{aggregateFunctions:n}=this;for(const{id:i,aggregate:a="sum"}of Object.values(this.series)){let o;a!==!1&&(o=n[a].entry)&&(t=o(i,t,...s))}return this.aggregateDataEntry?this.aggregateDataEntry(t,...s):t}internalInitAggregatedDataEntry(){const t=this.initAggregatedDataEntry?this.initAggregatedDataEntry(...arguments):{},{aggregateFunctions:s}=this;for(const{id:n,aggregate:i="sum"}of Object.values(this.series)){const a=s[i].init;a&&i!==!1&&a(n,t,...arguments)}return t}resetGeneratedRecordsHistogramDataCache(){const{store:t}=this;for(const s of this.getHistogramDataCache().keys())(s.isGroupHeader||s.generatedParent||s.isLinked&&!t.includes(s))&&this.clearHistogramDataCache(s)}setHistogramDataCache(t,s){if(super.setHistogramDataCache(t,s),t.isLinked)super.setHistogramDataCache(t.$original,s);else if(t.$links){const{store:n}=this;for(const i of t.$links)n.includes(i)&&super.setHistogramDataCache(i,s)}}getHistogramDataCache(t){let s=super.getHistogramDataCache(t);return!s&&t.isLinked&&(s=super.getHistogramDataCache(t.$original)),s}getGroupRecordHistogramData(t,s={}){s.parentRecord=t;const n=this.aggregateRecordsHistogramData(this.getGroupChildren(t),s);return N.isPromise(n)?n.then(i=>i):n}aggregateRecordsHistogramData(t,s={}){const n=this,i=[],{parentRecord:a}=s;let o=!1;for(const l of t){const c=n.getRecordHistogramData(l,s);o=o||N.isPromise(c),c&&i.push(c)}return o?Promise.all(i).then(l=>(s.parentRecord=a,l=l.filter(c=>c),n.aggregateHistogramData(l,t,s))):n.aggregateHistogramData(i,t,s)}isGroupRecord(t){return t.isGroupHeader||this.isTreeGrouped&&t.generatedParent}getGroupChildren(t){return t.groupChildren||t.children}getRecordParent(t){const{groupParent:s}=t;return(s==null?void 0:s.get(this.store.id))||this.isTreeGrouped&&t.parent}scheduleRecordParentsRefresh(t,s=!0){const n=this;let i;for(;i=n.getRecordParent(t);)s&&n.clearHistogramDataCache(i),n.scheduleRecordRefresh(i),t=i}aggregateHistogramData(t,s,n={}){const i=this,{aggregateFunctions:a}=i;n.recordsData=t,n.records=s;const o=t.map((c,d)=>i.extractHistogramDataArray(c,s[d])),l=ue.aggregate(o,i.getDataEntryForAggregating||(c=>c),i.internalAggregateDataEntry,i.internalInitAggregatedDataEntry,n);for(const{id:c,aggregate:d="sum"}of Object.values(i.series)){const u=a[d].finalize;u&&d!==!1&&u(c,l,...arguments)}return l}get widgetClass(){}},v(r,"$name","TimelineHistogramGrouping"),v(r,"configurable",{aggregateHistogramDataForGroups:!0,aggregateDataEntry:null,getDataEntryForAggregating:null,initAggregatedDataEntry:null,aggregateFunctions:{sum:{aliases:["add"],entry(t,s,n){return s[t]=(s[t]||0)+n[t],s}},min:{entry(t,s,n){const i=n[t];return i<(s[t]||Number.MAX_VALUE)&&(s[t]=i),s}},max:{entry(t,s,n){const i=n[t];return i>(s[t]||Number.MIN_VALUE)&&(s[t]=i),s}},count:{init(t,s,n,i){s[t]=i.arrays.length}},avg:{entry(t,s,n){return s[t]=(s[t]||0)+n[t],s},finalize(t,s,n,i,a){const o=a.arrays.length;s.forEach(l=>l[t]/=o)}}}}),r},we=e=>{var r;return r=class extends e{updateScalePoints(t){const s=this,n=t[t.length-1];n&&(s.scaleUnit=n.unit,s.histogramWidget.topValue=s.getTopValueByScalePoints(t)),s.scaleColumn&&(s.scaleColumn.scalePoints=t)}changeColumns(t,s){const n=this,i=n.getConfig("scaleColumn");if(t&&i){const a=Array.isArray(t);let o=t;a||(o=t.data);let l=o==null?void 0:o.length,c=i;o.some((d,u)=>{if(d.type==="scale")return l=u,c=W.assign(d,c),!0}),o=o.slice(),o[l]={type:"scale",...c},a?t=o:t.data=o}return super.changeColumns(t,s)}updateColumns(t,s){super.updateColumns(t,s),t&&(this._scaleColumn=this.columns.find(n=>n.isScaleColumn))}onColumnsChanged({action:t,changes:s,record:n,records:i}){const{scaleColumn:a,columns:o}=this;a&&(t==="dataset"||t==="batch")&&!o.includes(a)&&o.add(a,!0),super.onColumnsChanged(...arguments)}convertUnitsToHistogramValue(t,s){return t}convertHistogramValueToUnits(t,s){return t}extractHistogramDataArray(t,s){return t}getTopValueByScalePoints(t){const s=this,{scaleColumn:n}=s,i=t[t.length-1],{value:a,unit:o}=i;let l=a;return n&&(l*=1+(n.scaleWidget.scaleMaxPadding||0)),s.convertUnitsToHistogramValue(l,o||s.scaleUnit)}processRecordRenderData(t){var s;if(t=super.processRecordRenderData(...arguments),this.scaleColumn){const n=this,{record:i,histogramData:a,histogramConfig:o={}}=t;let l=(s=n.initialConfig.histogramWidget)==null?void 0:s.topValue,c=n.scalePoints||i.get(n.scalePointsModelField);if(!l){if(c&&n.calculateTopValueByScalePoints&&(l=n.getTopValueByScalePoints(c)),!l&&a){const d=t.histogramWidget||n.histogramWidget;W.assign(d,o),l=d.getDataTopValue(a),c=[{value:n.convertHistogramValueToUnits(l,n.scaleUnit),text:n.convertHistogramValueToUnits(l,n.scaleUnit)}],l+=n.scaleColumn.scaleWidget.scaleMaxPadding*l}t.scaleWidgetConfig={scalePoints:c},t.histogramConfig={...o,topValue:l}}}return t}buildGroupHeader(t){return t.column===this.scaleColumn?this.scaleColumn.renderer(t):super.buildGroupHeader(...arguments)}beforeRenderCell(t){return this.scaleColumn&&t.column===this.scaleColumn&&(t.histogramData=this.getRecordHistogramData(t.record),W.isPromise(t.histogramData)||Object.assign(t,this._recordRenderData)),super.beforeRenderCell(...arguments)}renderRecordScale(t,s){if(this.scaleColumn){const n=this.getRowFor(t),i=n==null?void 0:n.getCell(this.scaleColumn.id);i&&n.renderCell(i)}}get widgetClass(){}},v(r,"$name","TimelineHistogramScaleColumn"),v(r,"configurable",{scaleColumn:{},scalePoints:null,scalePointsModelField:"scalePoints",calculateTopValueByScalePoints:!0}),r},te=class extends k.mixin(Te,we){};v(te,"$name","TimelineHistogram"),v(te,"type","timelinehistogram"),te.initClass(),te._$name="TimelineHistogram";export{Se as DelayedRecordsRendering_default,he as DependencyEdit,$ as EventCopyPaste,ie as EventDrag,X as EventDragCreate,ae as EventTooltip,ne as ResourceTimeRangesBase,U as ScaleColumn,K as ScheduleContext,G as StickyEvents,oe as TimeRanges,te as TimelineHistogram,k as TimelineHistogramBase,Te as TimelineHistogramGrouping_default,we as TimelineHistogramScaleColumn_default};
//# sourceMappingURL=chunk-PS7L43WJ.js.map
