/*!
 *
 * Bryntum TaskBoard 5.6.2
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{GridFeatureManager as S}from"./chunk-GGOYEX2W.js";import{DragHelper as E}from"./chunk-6ZLMCHE5.js";import{Base as T,Delayable_default as B,DomHelper as b,InstancePlugin as D,Rectangle as F,__publicField as R}from"./chunk-MZVS5JQA.js";var v=class extends B(D){static get deprecatedEvents(){return{gridRowBeforeDragStart:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowBeforeDragStart` event is deprecated, listen on this event on the Grid instead."},gridRowDragStart:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowDragStart` event is deprecated, listen on this event on the Grid instead."},gridRowDrag:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowDrag` event is deprecated, listen on this event on the Grid instead."},gridRowBeforeDropFinalize:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowBeforeDropFinalize` event is deprecated, listen on this event on the Grid instead."},gridRowDrop:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowDrop` event is deprecated, listen on this event on the Grid instead."},gridRowAbort:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowAbort` event is deprecated, listen on this event on the Grid instead."}}}construct(e,t){this.grid=e,super.construct(...arguments)}doDestroy(){var e;(e=this.dragHelper)==null||e.destroy(),super.doDestroy()}init(){const e=this,{grid:t}=e;e.dragHelper=E.new({name:"rowReorder",cloneTarget:!0,dragThreshold:10,proxyTopOffset:10,targetSelector:".b-grid-row",lockX:!0,dragWithin:t.bodyContainer,allowDropOutside:!0,scrollManager:t.scrollManager,outerElement:e.targetSubGridElement,touchStartDelay:e.touchStartDelay,isElementDraggable:e.isElementDraggable.bind(e),monitoringConfig:{scrollables:[{element:t.scrollable.element,direction:"vertical"}]},setXY(a,r,i){const{context:s}=this;if(!s.started){const d=F.from(s.element,this.dragWithin),l=s.startPageY-globalThis.pageYOffset-s.element.getBoundingClientRect().top;i=d.top+l+this.proxyTopOffset}b.setTranslateXY(a,r,i)},ignoreSamePositionDrop:!1,createProxy(a){const r=a.cloneNode(!0),i=document.createElement("div");if(i.classList.add("b-row-reorder-proxy"),r.removeAttribute("id"),r.style.transform="",r.style.width="",i.appendChild(r),t.selectedRecords.length>1){const s=r.cloneNode(!0);s.classList.add("b-row-dragging-multiple"),i.appendChild(s)}return b.removeClsGlobally(i,"b-selected","b-hover","b-focused"),i},internalListeners:{beforedragstart:"onBeforeDragStart",dragstart:"onDragStart",drag:"onDrag",drop:"onDrop",abort:"onAbort",reset:"onReset",prio:1e4,thisObj:e}},e.dragHelperConfig),e.relayEvents(e.dragHelper,["beforeDragStart","dragStart","drag","abort"],"gridRow"),t.relayEvents(e.dragHelper,["beforeDragStart","dragStart","drag","abort"],"gridRow"),e.dropIndicator=b.createElement({className:"b-row-drop-indicator"}),e.dropOverTargetCls=["b-row-reordering-target","b-hover"]}get targetSubGridElement(){const e=this.grid.regions[0];return this.grid.subGrids[e].element}isElementDraggable(e,t){if(!e.closest(".b-grid-cell .b-widget"))if(this.gripOnly){const a=e.closest(".b-grid-cell:first-child");if(a){const r=getComputedStyle(a,":before"),i=this.grid.rtl?a.getBoundingClientRect().width-t.borderOffsetX:t.borderOffsetX,s=i<=parseFloat(r.width);return s&&(this.client.preventDragSelect=!0),s}}else return!0}onBeforeDragStart({event:e,source:t,context:a}){const r=this,{grid:i}=r,{group:s}=i.features,d=r.targetSubGridElement;if(e.target.classList.contains("b-rowexpander-shadowroot-container")||r.disabled||i.readOnly||i.isTreeGrouped||!d.contains(a.element))return!1;const l=a.startRecord=i.getRecordFromElement(a.element);if(s!=null&&s.enabled&&Array.isArray(l[i.features.group.field])||l.readOnly||l.isSpecialRow)return!1;a.originalRowTop=i.rowManager.getRowFor(l).top,i.selectionMode.checkboxOnly||(t.startEvent.pointerType==="touch"?i.isSelected(l)||i.selectRow({record:l,addToSelection:!1}):!i.isSelected(l)&&!e.shiftKey&&!e.ctrlKey&&i.selectRow({record:l}));const o=i.selectedRecords.filter(u=>!u.readOnly);return a.records=[l],o.includes(l)&&(a.records.push(...o.filter(u=>u!==l)),a.records.sort((u,n)=>i.store.indexOf(u)-i.store.indexOf(n))),!0}onDragStart({context:e}){var t,a;const r=this,{grid:i}=r,{cellEdit:s,cellMenu:d,headerMenu:l}=i.features;s&&(r.cellEditDisabledState=s.disabled,s.disabled=!0),(t=d==null?void 0:d.hideContextMenu)==null||t.call(d,!1),(a=l==null?void 0:l.hideContextMenu)==null||a.call(l,!1),i.element.classList.add("b-row-reordering");const o=e.element.querySelector(".b-focused");o==null||o.classList.remove("b-focused"),e.element.firstElementChild.classList.remove("b-selected","b-hover"),i.bodyContainer.appendChild(r.dropIndicator)}onDrag({context:e,event:t}){var a;const r=this,{grid:i}=r,{store:s,rowManager:d}=i,{clientY:l}=t;let o=!0,u=d.getRowAt(l),n,c,m,g,h;if(u){const p=u.top+i.scrollable.element.getBoundingClientRect().top-i.scrollable.y,f=u.height/4,y=p+f,O=p+u.height/2,G=p+f*3;c=u.dataIndex,n=s.getAt(c),s.tree?g=(n.isParent||r.dropOnLeaf)&&l>y&&l<G:s.isGrouped&&(g=n.isGroupHeader&&n.meta.collapsed),m=!g&&t.clientY>=O}else t.pageY<i._bodyRectangle.y?(c=0,n=s.first,m=!1):(c=s.count-1,n=s.last,m=!0),u=i.rowManager.getRow(c);if(n===r.overRecord&&r.after===m&&r.over===g){e.valid=r.reorderValid;return}r.overRecord!==n&&((a=d.getRowById(r.overRecord))==null||a.removeCls(r.dropOverTargetCls)),r.overRecord=n,r.after=m,r.over=g,(n===e.startRecord||!m&&!g&&c===0&&s.isGrouped||m&&n.isGroupHeader&&n.meta.collapsed&&s.indexOf(n)===s.count-1)&&(o=!1),s.tree?(h=m?n.nextSibling:n,e.records.some(p=>p.contains(n))&&(o=!1),e.parent=o&&g?n:n.parent,r.clearTimeout(r.hoverTimer),n&&n.isParent&&!n.isExpanded(s)&&(r.hoverTimer=r.setTimeout(()=>i.expand(n),r.hoverExpandTimeout))):h=m?s.getAt(c+1):n,u.toggleCls(r.dropOverTargetCls,o&&g),!g&&c===s.indexOf(e.startRecord)+(m?-1:1)&&e.parent&&e.startRecord.parent===e.parent&&(o=!1),u&&b.setTranslateY(r.dropIndicator,Math.max(u.top+(m?u.element.getBoundingClientRect().height:0),1)),r.dropIndicator.style.visibility=g?"hidden":"visible",r.dropIndicator.classList.toggle("b-drag-invalid",!o),e.insertBefore=h,e.valid=r.reorderValid=o}async onDrop(e){const t=this,{client:a}=t,{context:r}=e;if(r.valid=r.valid&&t.reorderValid,r.valid){r.async=!0,a.store.tree&&(r.oldPositionContext=r.records.map(s=>{var d;return{record:s,parentId:(d=s.parent)==null?void 0:d.id,parentIndex:s.parentIndex}}));let i=await t.trigger("gridRowBeforeDropFinalize",e);i===!1&&(r.valid=!1),i=await a.trigger("gridRowBeforeDropFinalize",e),i===!1&&(r.valid=!1),await t.dragHelper.animateProxyTo(t.dropIndicator,{align:"l0-l0"}),await t.finalizeReorder(r)}t.clearTimeout(t.hoverTimer),t.overRecord=t.after=t.over=null,t.trigger("gridRowDrop",e),a.trigger("gridRowDrop",e)}onAbort(e){this.client.trigger("gridRowDragAbort",e)}async finalizeReorder(e){var t,a;const r=this,{grid:i}=r,{store:s,focusedCell:d}=i;let{records:l}=e;if(e.valid=e.valid&&!l.some(o=>!s.includes(o)),e.valid){let o;if(s.tree)l=l.filter(u=>!u.parent||u.bubbleWhile(n=>!l.includes(n),!0)),o=await e.parent.tryInsertChild(l,r.over?(t=e.parent.children)==null?void 0:t[0]:e.insertBefore),i.rowManager.forEach(u=>u.removeCls(r.dropOverTargetCls)),!e.parent.isExpanded()&&((a=e.parent.children)!=null&&a.length)&&i.expand(e.parent),e.valid=o!==!1;else if(s.isGrouped&&r.over)s.move(l,s.getAt(s.indexOf(e.insertBefore)+1));else{if(l.length>1)for(;e.insertBefore&&l.includes(e.insertBefore);)e.insertBefore=s.getNext(e.insertBefore,!1,!0);s.move(l,e.insertBefore)}(d==null?void 0:d._rowIndex)>=0&&(i._focusedCell=null,i.focusCell({grid:i,record:d.record,columnId:d.columnId})),s.clearSorters()}e.finalize(e.valid),i.element.classList.remove("b-row-reordering")}onReset(){const e=this,{grid:t}=e,a=t.features.cellEdit;t.element.classList.remove("b-row-reordering"),a&&(a.disabled=e.cellEditDisabledState),e.dropIndicator.remove(),b.removeClsGlobally(t.element,...e.dropOverTargetCls)}onInternalPaint({firstPaint:e}){e&&this.init()}updateShowGrip(e){this.grid.element.classList.toggle("b-row-reorder-with-grip",e)}get isDragging(){return this.dragHelper.isDragging}};R(v,"$name","RowReorder"),R(v,"configurable",{showGrip:null,gripOnly:null,hoverExpandTimeout:1e3,touchStartDelay:300,dropOnLeaf:!1,dragHelperConfig:null}),R(v,"pluginConfig",{after:["onInternalPaint"]}),v.featureClass="",v._$name="RowReorder",S.registerFeature(v,!1);var C=e=>class extends(e||T){static get $name(){return"SummaryFormatter"}generateHtml(a,r,i,s,d,l){const o=this.store,u=a.summaries||(a.sum?[{sum:a.sum,renderer:a.summaryRenderer}]:[]);let n=`<div class="b-summary-wrap ${i}">`;return u.forEach(c=>{let m=c.sum,g=null;switch(m===!0&&(m="sum"),m){case"sum":case"add":g=o.sum(a.field,r);break;case"max":g=o.max(a.field,r);break;case"min":g=o.min(a.field,r);break;case"average":case"avg":g=o.average(a.field,r);break;case"count":g=r.length;break;case"countNotEmpty":g=r.reduce((h,p)=>{const f=p.getValue(a.field);return h+(f!=null?1:0)},0);break}if(typeof m=="function"&&(g=r.reduce(m,"seed"in c?c.seed:0)),g!==null){const h="b-grid-summary-value",p=c.label?`<div class="b-grid-summary-label">${c.label}</div>`:"";let f=c.renderer?c.renderer({config:c,sum:g}):g,y;f==null&&(f=""),String(f).includes("<div>")?y=f:y=p?`${p}<div class="${h}">${f}</div>`:`<div class="${h} b-nolabel">${f}</div>`,n+=y}}),`${n}</div>`}},w=class extends C(D){static get configurable(){return{selectedOnly:null,hideFooters:!1}}static get pluginConfig(){return{chain:["renderRows","bindStore"]}}static get $name(){return"Summary"}construct(e,t){this.grid=e,super.construct(e,t),this.bindStore(e.store),e.hideFooters=this.hideFooters}bindStore(e){this.detachListeners("store"),e.ion({name:"store",change:"onStoreChange",thisObj:this})}get store(){return this.grid.store}doDestroy(){super.doDestroy()}doDisable(e){super.doDisable(e);const{client:t}=this;e?t.element.classList.add("b-summary-disabled"):(this.updateSummaries(),t.element.classList.remove("b-summary-disabled"),t.eachSubGrid(a=>a.scrollable.syncPartners()))}renderRows(){this.updateSummaries()}updateSummaries(){const e=this,{grid:t,store:a}=e,r=b.children(t.element,".b-grid-footer"),i=e.selectedOnly&&t.selectedRecords.length>0,s=(a.isFiltered?a.storage.values:a.allRecords).filter(d=>!d.isSpecialRow&&(!i||t.isSelected(d)));t.columns.forEach(d=>{var l;(l=d.summaries)==null||l.forEach(o=>{"seed"in o&&("initialSeed"in o||(o.initialSeed=o.seed),["number","string","date"].includes(typeof o.initialSeed)?o.seed=o.initialSeed:o.seed=Object.assign({},o.initialSeed))})}),r.forEach(d=>{if(!d.dataset.column)return;const l=t.columns.get(d.dataset.column),o=e.generateHtml(l,s,"b-grid-footer-summary");(l.summaries?l.summaries.length:l.sum)&&(d.children.length?b.sync(o,d.firstElementChild):d.innerHTML=o)})}onStoreChange({action:e,changes:t}){let a=!0;this.disabled||(e==="update"&&(a=Object.keys(t).some(r=>{const i=this.grid.columns.get(r);return!!i&&(!!i.sum||!!i.summaries)})),a&&this.updateSummaries())}updateSelectedOnly(e){const t=this;t.detachListeners("selectionChange"),e&&t.grid.ion({name:"selectionChange",selectionChange:t.refresh,thisObj:t}),t.refresh()}refresh(){this.updateSummaries()}};w.featureClass="b-summary",w._$name="Summary",S.registerFeature(w);export{v as RowReorder,w as Summary,C as SummaryFormatter_default};
//# sourceMappingURL=chunk-JZO6LOO7.js.map
